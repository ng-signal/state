<div class="list-container">
  <div class="header">
    <h3>{{ title }}</h3>
  </div>
  <!-- LOADING -->
  @if (userList.isLoading()) {
    <div class="loading-state">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Loading users ({{ spinnerTitle }}) ...</p>
    </div>
  }

  <!-- ERROR -->
  @if (userList.error()) {
    <div class="error-state">
      <mat-icon color="warn">error_outline</mat-icon>
      <p>{{ userList.error()?.message }}</p>
      <button mat-flat-button color="primary" (click)="retry()">Retry</button>
    </div>
  }

  <mat-accordion class="insight-accordion" multi>
    <!-- USERS: Reactive Fetch -->
    <mat-expansion-panel [expanded]="true">
      <mat-expansion-panel-header>
        <mat-panel-title>Reactive Fetch (Users)</mat-panel-title>
        <mat-panel-description>Fetched from User Store</mat-panel-description>
      </mat-expansion-panel-header>

      @for (user of userList.value(); track user.id) {
        <ngvault-info-icon [data]="user" [icon]="'person'" class="info-icon" />
      }
    </mat-expansion-panel>

    <!-- USERS: Reactive Signal Selector -->
    <mat-expansion-panel [expanded]="true">
      <mat-expansion-panel-header>
        <mat-panel-title>Reactive Signal Selector</mat-panel-title>
        <mat-panel-description>Derived first + last names</mat-panel-description>
      </mat-expansion-panel-header>

      @for (user of usersWithName(); track user.id) {
        <ngvault-info-icon [data]="user" [icon]="'person'" class="info-icon" />
      }
    </mat-expansion-panel>

    <!-- CARS: Reactive Fetch -->
    <mat-expansion-panel [expanded]="true">
      <mat-expansion-panel-header>
        <mat-panel-title>Reactive Fetch (Cars)</mat-panel-title>
        <mat-panel-description>Fetched from Car Store</mat-panel-description>
      </mat-expansion-panel-header>

      @for (car of cars.value(); track car.id) {
        <ngvault-info-icon [data]="car" [icon]="'directions_car'" class="info-icon" />
      }
    </mat-expansion-panel>

    <!-- SMART MATCH INSIGHT -->
    <mat-expansion-panel [expanded]="true">
      <mat-expansion-panel-header>
        <mat-panel-title>Smart Match Insight</mat-panel-title>
        <mat-panel-description>Reactive, signal-driven data fusion of users â†” cars</mat-panel-description>
      </mat-expansion-panel-header>

      @if (usersWithoutCars()) {
        <section class="no-car-list">
          <h4>Users without assigned cars</h4>
          @for (user of usersWithoutCars(); track user.id) {
            <ngvault-info-icon [data]="user" [icon]="'no_cars_custom'" class="info-icon" />
          }
        </section>
      } @else {
        <p class="empty-state">All users have cars assigned.</p>
      }
    </mat-expansion-panel>

    <!-- GROUPED BY MAKE -->
    <mat-expansion-panel [expanded]="true">
      <mat-expansion-panel-header>
        <mat-panel-title>Owners grouped by make</mat-panel-title>
        <mat-panel-description>Organized list of car owners per manufacturer</mat-panel-description>
      </mat-expansion-panel-header>

      @if (groupedByMake()) {
        @for (group of groupedByMake(); track group.make) {
          <h4>
            {{ group.make }}
            {{ group.users.length }} owner(s)
          </h4>
          @for (user of usersWithoutCars(); track user.id) {
            <ngvault-info-icon [data]="user" [icon]="'person'" class="info-icon" />
          }
        }
      } @else {
        <p class="empty-state">No makes found yet.</p>
      }
    </mat-expansion-panel>
  </mat-accordion>
</div>
