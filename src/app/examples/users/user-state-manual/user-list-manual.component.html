<div class="list-container">
  <div class="header">
    <h3>{{ title }}</h3>
  </div>
  <!-- LOADING -->
  @if (userList.loading()) {
    <div class="loading-state">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Loading users ({{ spinnerTitle }}) ...</p>
    </div>
  }

  <!-- ERROR -->
  @if (userList.error()) {
    <div class="error-state">
      <mat-icon color="warn">error_outline</mat-icon>
      <p>{{ userList.error()?.message }}</p>
      <button mat-flat-button color="primary" (click)="retry()">Retry</button>
    </div>
  }

  <mat-accordion class="insight-accordion" multi>
    <!-- USERS: Reactive Fetch -->
    <mat-expansion-panel [expanded]="true">
      <mat-expansion-panel-header>
        <mat-panel-title>ðŸ‘¥ Reactive Fetch (Users)</mat-panel-title>
        <mat-panel-description>Fetched from User Store</mat-panel-description>
      </mat-expansion-panel-header>

      @for (user of userList.data(); track user.id) {
        <mat-card class="item-card">
          <mat-card-header>
            <mat-icon mat-card-avatar>person</mat-icon>
            <mat-card-title>{{ user.name }}</mat-card-title>
            <mat-card-subtitle>ID: {{ user.id }}</mat-card-subtitle>
          </mat-card-header>
        </mat-card>
      }
    </mat-expansion-panel>

    <!-- USERS: Reactive Signal Selector -->
    <mat-expansion-panel [expanded]="true">
      <mat-expansion-panel-header>
        <mat-panel-title>Reactive Signal Selector</mat-panel-title>
        <mat-panel-description>Derived first + last names</mat-panel-description>
      </mat-expansion-panel-header>

      @for (user of usersWithName(); track user.id) {
        <mat-card class="item-card">
          <mat-card-header>
            <mat-icon mat-card-avatar>person</mat-icon>
            <mat-card-title>{{ user.firstName }} {{ user.lastName }}</mat-card-title>
            <mat-card-subtitle>ID: {{ user.id }}</mat-card-subtitle>
          </mat-card-header>
        </mat-card>
      }
    </mat-expansion-panel>

    <!-- CARS: Reactive Fetch -->
    <mat-expansion-panel [expanded]="true">
      <mat-expansion-panel-header>
        <mat-panel-title>Reactive Fetch (Cars)</mat-panel-title>
        <mat-panel-description>Fetched from Car Store</mat-panel-description>
      </mat-expansion-panel-header>

      @for (car of cars.data(); track car.id) {
        <mat-card class="item-card">
          <mat-card-header>
            <mat-icon mat-card-avatar>directions_car</mat-icon>
            <mat-card-title>{{ car.year }} {{ car.make }} {{ car.model }}</mat-card-title>
            <mat-card-subtitle>ID: {{ car.id }}</mat-card-subtitle>
          </mat-card-header>
        </mat-card>
      }
    </mat-expansion-panel>

    <!-- SMART MATCH INSIGHT -->
    <mat-expansion-panel [expanded]="true">
      <mat-expansion-panel-header>
        <mat-panel-title>Smart Match Insight</mat-panel-title>
        <mat-panel-description>Reactive, signal-driven data fusion of users â†” cars</mat-panel-description>
      </mat-expansion-panel-header>

      @if (usersWithoutCars()) {
        <section class="no-car-list">
          <h4>Users without assigned cars</h4>
          @for (user of usersWithoutCars(); track user.id) {
            <mat-card class="item-card alert">
              <mat-card-header>
                <mat-icon mat-card-avatar color="warn">warning</mat-icon>
                <mat-card-title>{{ user.name }}</mat-card-title>
                <mat-card-subtitle>No car assigned yet</mat-card-subtitle>
              </mat-card-header>
            </mat-card>
          }
        </section>
      } @else {
        <p class="empty-state">All users have cars assigned.</p>
      }
    </mat-expansion-panel>

    <!-- GROUPED BY MAKE -->
    <mat-expansion-panel [expanded]="true">
      <mat-expansion-panel-header>
        <mat-panel-title>Owners grouped by make</mat-panel-title>
        <mat-panel-description>Organized list of car owners per manufacturer</mat-panel-description>
      </mat-expansion-panel-header>

      @if (groupedByMake()) {
        @for (group of groupedByMake(); track group.make) {
          <mat-card class="item-card make-group">
            <mat-card-header>
              <mat-icon mat-card-avatar color="primary">directions_car</mat-icon>
              <mat-card-title>{{ group.make }}</mat-card-title>
              <mat-card-subtitle>{{ group.users.length }} owner(s)</mat-card-subtitle>
            </mat-card-header>

            <mat-card-content>
              @for (user of group.users; track user.id) {
                <div class="user-line">
                  <mat-icon>person</mat-icon>
                  <span>{{ user.name }}</span>
                </div>
              }
            </mat-card-content>
          </mat-card>
        }
      } @else {
        <p class="empty-state">No makes found yet.</p>
      }
    </mat-expansion-panel>
  </mat-accordion>
</div>
